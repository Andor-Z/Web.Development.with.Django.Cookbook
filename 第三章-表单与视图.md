# 第三章-表单和视图
***************
在本章，我们学习以下内容：  

```
传递HttpRequest到表单

利用表单的save方法

上传图片

使用django-crispy-forms生成表单布局

过滤对象列表

管理分页列表

编写类视图

生成PDF文档
```
## 引言
当数据库结构定在模型中时，我们需要有一些视图供用户输入数据，或者对用户显示数据。本章，我们会关注管理表单的视图，列表视图，以及生成可替换的输出而不仅仅是HTML。举个最简单的例子来说，我们将把模板和URL规则的创建的决定权下放给你。  

## 传递HttpRequest到表单
Django的每一个视图的第一个参数通常是命名为`request`的`HttpRequest`对象。它包含了请求的元数据，例如，当前语言编码，当前用户，当前cookie，或者是当前的session。默认，表单用在视图中用来接受GET胡诌和POST参数，文件，初始化数据，以及其他的参数，但却不是`HttpRequest`对象暗沟。某些情况下，特别是当你想要使用请求数据过滤出表单字段的选择，又或者是你想要处理像在表单中保存当前用户或者当前IP这样事情时，额外地传递地`HttpRequest`到表单会非常有用的。  

在本方法中，我会向你展示一个在表单中某人可以选择一个用户并对此用户发送消息的例子。我们会传递`HttpRequest`对象到表单以暴露接受选项的当前用户：我们不想要任何人都可以给他们发送消息。  
## 预热
让我们来创建一个叫做`email_messages`的应用，并把它放到设置中的`INSTALLED_APPS`去。该app仅含有表单和视图而没有模型。  

## 具体做法
1. 添加一个新文件，`forms.py`，其中消息表单包含两个字段：接收人选项和消息文本。同时，该表单拥有一个初始化方法，它会接受`request`对象并对接收人的选项字段修改：  

```python
# -*- coding: UTF-8 -*-
from django import forms
from django.utils.translation import ugettext_lazy as _
from django.contrib.auth.models import User

class MessageForm(forms.Form):
    recipient = forms.ModelChoiceField(
        label=_("Recipient"),
        queryset=User.objects.all(),
        required=True,
    )
    message = forms.CharField(
        label=_("Message"),
        widget=forms.Textarea,
        required=True,
    )
    
    def __init__(self, request, *args, **kwargs):
    super(MessageForm, self).__init__(*args, **kwargs)
    self.request = request
    self.fields['recipient'].queryset = self.fields['recipient'].queryset.exclude(pk=request.user.pk)
```

2. 然后，利用`message_to_user`视图创建`views.py`以处理表单。如你所见，`request`对象作为第一个参数被传递到了表单：  

```python
#email_messages/views.py
# -*- coding: UTF-8 -*-
from django.contrib.auth.decorators import login_required
from django.shortcuts import render, redirect

from forms import MessageForm

@login_required
def message_to_user(request):
    if request.method == "POST":
        form = MessageForm(request, data=request.POST)
        if form.is_valid():
            # do something with the form
        return redirect("message_to_user_done")
    else:
        form = MessageForm(request)
    return render(request, "email_messages/message_to_user.html", {'form:form'})
```

## 工作原理
在初始化方法中，我们拥有表现表单自身实例的`self`变量，然后是新近添加的`request`变量，在然后是位置参数（`*args`）和命名参数（`**kwargs`）。我们调用`super`构造方法传递所有的位置参数以及命名参数，这样表单就可以正确地初始化。接着，我们把`request`变量赋值到一个新的表单的`request`变量，以便之后在表单的其他方法中可以访问。再然后，我们修改接收人选项字段的`queryset`属性以便从request暴露当前用户。  

在视图中，我们将`HttpRequest`作为两种场合下的第一个参数来传递：当表单第一次载入时，以及表单发布之后。  

## 参阅
利用表单的save方法  

## 利用表单的save方法
为了让视图变得简洁和简单，
